@page "/"
@using System.Net.Http
@using BitcoinChallenge.Entities;
@using Newtonsoft.Json;
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject ILiffClient Liff

    <div class="card" style="width: 20rem;">
        <h5 class="card-title">Current price of one bitcoin</h5>
        <p>@FormattedPrice</p>
    </div>

@code{
    private const string BitcoinPriceProvider = "https://api.coinbase.com/v2/prices/spot?currency=EUR";

    protected decimal Price { get; set; }
    protected string FormattedPrice => string.Format("€{0:N2}", this.Price);

    protected override async Task OnInitializedAsync() {
        try {
            this.Price = await this.fetchPrice();
        }
        catch (Exception e) {
            await JSRuntime.InvokeAsync<object>("alert", e.ToString());
        }
    }

    private async Task<decimal> fetchPrice() {
        HttpResponseMessage priceResponse = await Http.GetAsync(BitcoinPriceProvider);
        priceResponse.EnsureSuccessStatusCode();
        string responseBody = await priceResponse.Content.ReadAsStringAsync();
        BitcoinPriceWrapper bitcoinPriceWrapper = JsonConvert.DeserializeObject<BitcoinPriceWrapper>(responseBody);
        return decimal.Parse(bitcoinPriceWrapper.Data.Amount);
    }
}
